<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matter.js Collision Test - Ghost vs Shadow Balls</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        #canvas-container {
            position: relative;
            margin: 20px auto;
            border: 2px solid #444;
            background-color: #2a2a2a;
            width: 800px;
            height: 600px;
        }

        #controls {
            text-align: center;
            margin-bottom: 20px;
        }

        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        button.danger {
            background-color: #f44336;
        }

        button.danger:hover {
            background-color: #da190b;
        }

        #info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #333;
            border-radius: 4px;
            max-width: 800px;
            margin: 20px auto;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-box {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .ghost-color {
            background-color: rgba(76, 175, 80, 0.6);
        }

        .shadow-color {
            background-color: rgba(33, 150, 243, 1);
        }

        #stats {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }

        #collision-log {
            max-width: 800px;
            margin: 20px auto;
            background-color: #222;
            border: 2px solid #444;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        #collision-log h3 {
            margin-top: 0;
            color: #4CAF50;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            background-color: #2a2a2a;
            border-left: 3px solid #4CAF50;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry.success {
            border-left-color: #4CAF50;
        }

        .log-entry.warning {
            border-left-color: #FFC107;
        }

        .log-entry.error {
            border-left-color: #f44336;
        }

        #collision-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 10px 0;
            font-size: 16px;
        }

        .stat-item {
            padding: 10px 20px;
            background-color: #333;
            border-radius: 4px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        #collision-overlay {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Matter.js Collision Test: Ghost vs Shadow Balls</h1>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-box ghost-color"></div>
            <span>Ghost Ball (Dynamic - Client Predicted)</span>
        </div>
        <div class="legend-item">
            <div class="legend-box shadow-color"></div>
            <span>Shadow Ball (Static - Server Authority)</span>
        </div>
    </div>

    <div id="controls">
        <button onclick="spawnGhostBall()">Spawn Ghost Ball</button>
        <button class="secondary" onclick="spawnShadowBall()">Spawn Shadow Ball (Random Velocity)</button>
        <button class="secondary" onclick="spawnShadowBallStationary()">Spawn Stationary Shadow</button>
        <button class="danger" onclick="clearAll()">Clear All</button>
        <button onclick="toggleGravity()">Toggle Gravity</button>
        <button onclick="runAutomatedTest()" style="background-color: #FF9800;">Run Automated Test</button>
    </div>

    <div id="collision-stats">
        <div class="stat-item">
            <div>Total Collisions</div>
            <div class="stat-number" id="total-collisions">0</div>
        </div>
        <div class="stat-item">
            <div>Ghost-Shadow Collisions</div>
            <div class="stat-number" id="ghost-shadow-collisions">0</div>
        </div>
        <div class="stat-item">
            <div>False Positives</div>
            <div class="stat-number" id="false-positives">0</div>
        </div>
    </div>

    <div id="canvas-container">
        <div id="collision-overlay"></div>
    </div>

    <div id="info">
        <h3>Test Concept</h3>
        <p>This validates the hybrid prediction model:</p>
        <ul style="text-align: left; max-width: 600px; margin: 10px auto;">
            <li><strong>Ghost Balls (Green):</strong> Dynamic bodies simulating user-spawned objects during the ~100ms confirmation window</li>
            <li><strong>Shadow Balls (Blue):</strong> Static bodies representing server-authoritative objects with velocity metadata</li>
            <li>Ghost balls can collide with shadow balls for prediction</li>
            <li>Velocity vectors shown as red arrows on shadow balls</li>
        </ul>
    </div>

    <div id="stats">
        <span id="ghost-count">Ghost Balls: 0</span> |
        <span id="shadow-count">Shadow Balls: 0</span> |
        <span id="gravity-status">Gravity: ON</span>
    </div>

    <!-- Matter.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script type="module">
        // Matter.js modules
        const { Engine, Render, World, Bodies, Body, Events, Vector } = Matter;

        // Create engine
        const engine = Engine.create();
        const world = engine.world;

        // Create renderer
        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: {
                width: 800,
                height: 600,
                wireframes: false,
                background: '#2a2a2a'
            }
        });

        // Create ground
        const ground = Bodies.rectangle(400, 590, 810, 20, {
            isStatic: true,
            render: {
                fillStyle: '#666'
            }
        });
        World.add(world, ground);

        // Create walls
        const leftWall = Bodies.rectangle(5, 300, 10, 600, {
            isStatic: true,
            render: { fillStyle: '#666' }
        });
        const rightWall = Bodies.rectangle(795, 300, 10, 600, {
            isStatic: true,
            render: { fillStyle: '#666' }
        });
        const ceiling = Bodies.rectangle(400, 5, 810, 10, {
            isStatic: true,
            render: { fillStyle: '#666' }
        });
        World.add(world, [leftWall, rightWall, ceiling]);

        // Run the engine
        Engine.run(engine);
        Render.run(render);

        // Tracking arrays
        const ghostBalls = [];
        const shadowBalls = [];
        let gravityEnabled = true;

        // Spawn a ghost ball (dynamic body - client predicted)
        window.spawnGhostBall = function(x = null, y = null) {
            const spawnX = x !== null ? x : 100 + Math.random() * 600;
            const spawnY = y !== null ? y : 50 + Math.random() * 200;
            const radius = 20 + Math.random() * 20;

            const ghostBall = Bodies.circle(spawnX, spawnY, radius, {
                restitution: 0.8,
                friction: 0.01,
                density: 0.001,
                render: {
                    fillStyle: 'rgba(76, 175, 80, 0.6)',
                    strokeStyle: '#4CAF50',
                    lineWidth: 2
                }
            });

            // Add random initial velocity
            Body.setVelocity(ghostBall, {
                x: (Math.random() - 0.5) * 10,
                y: (Math.random() - 0.5) * 10
            });

            ghostBalls.push(ghostBall);
            World.add(world, ghostBall);
            updateStats();
        };

        // Spawn a shadow ball (static body with velocity metadata)
        window.spawnShadowBall = function(x = null, y = null, radius = null, vx = null, vy = null) {
            const spawnX = x !== null ? x : 100 + Math.random() * 600;
            const spawnY = y !== null ? y : 100 + Math.random() * 400;
            const ballRadius = radius !== null ? radius : 20 + Math.random() * 20;
            const velocityX = vx !== null ? vx : (Math.random() - 0.5) * 8;
            const velocityY = vy !== null ? vy : (Math.random() - 0.5) * 8;

            const shadowBall = Bodies.circle(spawnX, spawnY, ballRadius, {
                isStatic: true,
                render: {
                    fillStyle: '#2196F3',
                    strokeStyle: '#1976D2',
                    lineWidth: 2
                }
            });

            // Attach velocity metadata (server-provided)
            shadowBall.velocityMetadata = {
                vx: velocityX,
                vy: velocityY
            };

            shadowBalls.push(shadowBall);
            World.add(world, shadowBall);
            updateStats();
        };

        // Spawn a stationary shadow ball (zero velocity)
        window.spawnShadowBallStationary = function() {
            const spawnX = 100 + Math.random() * 600;
            const spawnY = 100 + Math.random() * 400;
            const radius = 20 + Math.random() * 20;

            window.spawnShadowBall(spawnX, spawnY, radius, 0, 0);
        };

        // Clear all balls
        window.clearAll = function() {
            ghostBalls.forEach(ball => World.remove(world, ball));
            shadowBalls.forEach(ball => World.remove(world, ball));
            ghostBalls.length = 0;
            shadowBalls.length = 0;
            updateStats();
        };

        // Toggle gravity
        window.toggleGravity = function() {
            gravityEnabled = !gravityEnabled;
            engine.world.gravity.y = gravityEnabled ? 1 : 0;
            document.getElementById('gravity-status').textContent =
                `Gravity: ${gravityEnabled ? 'ON' : 'OFF'}`;
        };

        // Update statistics
        function updateStats() {
            document.getElementById('ghost-count').textContent = `Ghost Balls: ${ghostBalls.length}`;
            document.getElementById('shadow-count').textContent = `Shadow Balls: ${shadowBalls.length}`;
        }

        // Render velocity vectors on shadow balls
        Events.on(render, 'afterRender', function() {
            const context = render.context;

            shadowBalls.forEach(shadowBall => {
                if (!shadowBall.velocityMetadata) return;

                const { vx, vy } = shadowBall.velocityMetadata;
                const pos = shadowBall.position;

                // Scale velocity for visualization
                const scale = 5;
                const endX = pos.x + vx * scale;
                const endY = pos.y + vy * scale;

                // Draw velocity arrow
                context.beginPath();
                context.strokeStyle = '#ff0000';
                context.lineWidth = 2;
                context.moveTo(pos.x, pos.y);
                context.lineTo(endX, endY);
                context.stroke();

                // Draw arrowhead
                const angle = Math.atan2(vy, vx);
                const arrowLength = 10;
                context.beginPath();
                context.moveTo(endX, endY);
                context.lineTo(
                    endX - arrowLength * Math.cos(angle - Math.PI / 6),
                    endY - arrowLength * Math.sin(angle - Math.PI / 6)
                );
                context.moveTo(endX, endY);
                context.lineTo(
                    endX - arrowLength * Math.cos(angle + Math.PI / 6),
                    endY - arrowLength * Math.sin(angle + Math.PI / 6)
                );
                context.strokeStyle = '#ff0000';
                context.lineWidth = 2;
                context.stroke();
            });
        });

        // Log collision events
        Events.on(engine, 'collisionStart', function(event) {
            const pairs = event.pairs;

            pairs.forEach(pair => {
                const bodyA = pair.bodyA;
                const bodyB = pair.bodyB;

                // Check if collision involves a ghost and shadow ball
                const isGhostA = ghostBalls.includes(bodyA);
                const isGhostB = ghostBalls.includes(bodyB);
                const isShadowA = shadowBalls.includes(bodyA);
                const isShadowB = shadowBalls.includes(bodyB);

                if ((isGhostA && isShadowB) || (isGhostB && isShadowA)) {
                    console.log('COLLISION: Ghost ball hit Shadow ball', {
                        ghostVelocity: isGhostA ? bodyA.velocity : bodyB.velocity,
                        shadowMetadata: isGhostA ? bodyB.velocityMetadata : bodyA.velocityMetadata
                    });
                }
            });
        });

        // Initialize with some test objects
        console.log('Matter.js Collision Test initialized successfully');
        console.log('Engine:', engine);
        console.log('Use buttons to spawn ghost and shadow balls');

        // Auto-spawn initial test objects
        spawnGhostBall(200, 100);
        spawnShadowBall(600, 300, 30, 2, 1);
        spawnShadowBallStationary();
    </script>
</body>
</html>

System.register(["./pixi-legacy-BIyxiMpA.js"],function(e,t){"use strict";var s,o,n,i;return{setters:[e=>{s=e.C,o=e.G,n=e.T,i=e.A}],execute:function(){var e=document.createElement("style");e.textContent=".remote-cursor{position:absolute;pointer-events:none;z-index:1000;transition:left .1s ease-out,top .1s ease-out}.remote-cursor-pointer{width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:20px solid;transform:rotate(-45deg);transform-origin:center top}.remote-cursor-label{position:absolute;top:20px;left:10px;padding:2px 8px;background:rgba(0,0,0,.8);color:#fff;font-size:12px;border-radius:4px;white-space:nowrap;user-select:none}.selection-box{position:absolute;border:2px dashed #5a9cb0;background:rgba(90,156,176,.1);pointer-events:none;z-index:999}.resize-handle{position:absolute;width:8px;height:8px;background:#fff;border:2px solid #5a9cb0;border-radius:2px}.resize-handle.nw{cursor:nw-resize;top:-5px;left:-5px}.resize-handle.ne{cursor:ne-resize;top:-5px;right:-5px}.resize-handle.sw{cursor:sw-resize;bottom:-5px;left:-5px}.resize-handle.se{cursor:se-resize;bottom:-5px;right:-5px}.resize-handle.n{cursor:n-resize;top:-5px;left:50%;transform:translate(-50%)}.resize-handle.s{cursor:s-resize;bottom:-5px;left:50%;transform:translate(-50%)}.resize-handle.w{cursor:w-resize;left:-5px;top:50%;transform:translateY(-50%)}.resize-handle.e{cursor:e-resize;right:-5px;top:50%;transform:translateY(-50%)}.notification{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:4px;color:#fff;font-size:14px;z-index:10000;animation:slideIn .3s ease-out}@keyframes slideIn{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}.notification.info{background:#4a7c8e}.notification.success{background:#4caf50}.notification.warning{background:#ff9800}.notification.error{background:#f44336}.loading-spinner{border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top:3px solid white;width:20px;height:20px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}@media (max-width: 768px){#toolbar{top:10px;left:10px;padding:5px}.tool-btn{width:35px;height:35px;font-size:16px}#presence-list{top:10px;right:10px;min-width:150px}#status-bar{font-size:11px;padding:6px 15px}}@media print{#toolbar,#presence-list,#status-bar,#auth-modal{display:none!important}}\n/*$vite$:1*/",document.head.appendChild(e);class t{constructor(e){this.app=e,this.viewport=new s,this.objects=new Map,this.selectedObjects=new Set,this.selectionIndicators=new Map,this.remoteCursors=new Map,this.isPanning=!1,this.panStart={x:0,y:0},this.currentTool="select",this.currentColor=3447003,this.app.stage.addChild(this.viewport),this.viewport.sortableChildren=!0,this.drawGrid(),this.setupPanZoom(),this.setupKeyboardShortcuts(),this.setupToolHandlers(),console.log("Canvas initialized")}drawGrid(){const e=new o;e.lineStyle(1,3355443,.3);const t=5e3;for(let s=-5e3;s<=t;s+=50)e.moveTo(s,-5e3),e.lineTo(s,t);for(let s=-5e3;s<=t;s+=50)e.moveTo(-5e3,s),e.lineTo(t,s);e.zIndex=-1,this.viewport.addChild(e)}setupPanZoom(){const e=this.app.view;e.addEventListener("mousedown",t=>{(1===t.button||0===t.button&&t.altKey)&&(this.isPanning=!0,this.panStart={x:t.clientX,y:t.clientY},e.style.cursor="grabbing",t.preventDefault())}),e.addEventListener("mousemove",e=>{if(this.isPanning){const t=e.clientX-this.panStart.x,s=e.clientY-this.panStart.y;this.viewport.x+=t,this.viewport.y+=s,this.panStart={x:e.clientX,y:e.clientY}}}),e.addEventListener("mouseup",()=>{this.isPanning&&(this.isPanning=!1,e.style.cursor="default")}),e.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1,s=e.clientX,o=e.clientY,n=this.screenToWorld(s,o),i=this.viewport.scale.x*t;if(i>=.1&&i<=10){this.viewport.scale.set(i);const e=this.screenToWorld(s,o);this.viewport.x+=(e.x-n.x)*this.viewport.scale.x,this.viewport.y+=(e.y-n.y)*this.viewport.scale.y}},{passive:!1})}screenToWorld(e,t){return{x:(e-this.viewport.x)/this.viewport.scale.x,y:(t-this.viewport.y)/this.viewport.scale.y}}worldToScreen(e,t){return{x:e*this.viewport.scale.x+this.viewport.x,y:t*this.viewport.scale.y+this.viewport.y}}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{"r"===e.key||"R"===e.key?this.setTool("rectangle"):"c"===e.key||"C"===e.key?this.setTool("circle"):"t"===e.key||"T"===e.key?this.setTool("text"):"v"===e.key||"V"===e.key||"Escape"===e.key?this.setTool("select"):"Delete"!==e.key&&"Backspace"!==e.key||this.deleteSelected()})}setTool(e){this.currentTool=e,console.log("Tool:",e)}setupToolHandlers(){const e=this.app.view;let t=null,s=null;e.addEventListener("mousemove",e=>{const o=this.screenToWorld(e.clientX,e.clientY);if(this.onCursorMoved&&this.onCursorMoved(o.x,o.y),t&&s){const e=o.x-t.x,n=o.y-t.y;if(s.clear(),s.beginFill(this.currentColor),"rectangle"===this.currentTool)s.drawRect(t.x,t.y,e,n);else if("circle"===this.currentTool){const o=Math.sqrt(e*e+n*n);s.drawCircle(t.x,t.y,o)}s.endFill()}}),e.addEventListener("mousedown",e=>{if(0!==e.button||e.altKey)return;const n=this.screenToWorld(e.clientX,e.clientY);"rectangle"!==this.currentTool&&"circle"!==this.currentTool||(t=n,s=new o,s.alpha=.5,this.viewport.addChild(s))}),e.addEventListener("mouseup",e=>{if(t&&s){const o=this.screenToWorld(e.clientX,e.clientY),n=this.createToolObject(t,o);this.viewport.removeChild(s),s=null,t=null,this.onObjectCreated&&this.onObjectCreated(n)}})}createToolObject(e,t){const s=this.generateId();if("rectangle"===this.currentTool){const o=Math.abs(t.x-e.x),n=Math.abs(t.y-e.y),i=Math.min(e.x,t.x),r=Math.min(e.y,t.y);return this.createRectangle(s,i,r,o,n,this.currentColor),{id:s,type:"rectangle",x:i,y:r,width:o,height:n,color:this.currentColor}}if("circle"===this.currentTool){const o=t.x-e.x,n=t.y-e.y,i=Math.sqrt(o*o+n*n);return this.createCircle(s,e.x,e.y,i,this.currentColor),{id:s,type:"circle",x:e.x,y:e.y,radius:i,color:this.currentColor}}}createRectangle(e,t,s,n,i,r){const a=new o;return a.beginFill(r),a.drawRect(0,0,n,i),a.endFill(),a.x=t,a.y=s,a.interactive=!0,a.buttonMode=!0,a.userData={width:n,height:i,type:"rectangle"},this.makeDraggable(a,e),this.makeSelectable(a,e),this.objects.set(e,a),this.viewport.addChild(a),a}createCircle(e,t,s,n,i){const r=new o;return r.beginFill(i),r.drawCircle(0,0,n),r.endFill(),r.x=t,r.y=s,r.interactive=!0,r.buttonMode=!0,r.userData={radius:n,type:"circle"},this.makeDraggable(r,e),this.makeSelectable(r,e),this.objects.set(e,r),this.viewport.addChild(r),r}createText(e,t,s,o,i,r){const a=new n(t,{fontSize:i,fill:r,fontFamily:"Arial"});return a.x=s,a.y=o,a.interactive=!0,a.buttonMode=!0,this.makeDraggable(a,e),this.makeSelectable(a,e),this.objects.set(e,a),this.viewport.addChild(a),a}makeDraggable(e,t){let s=null,o={x:0,y:0},n=0;e.on("pointerdown",t=>{if("select"!==this.currentTool)return;s=t.data,e.alpha=.7,s.dragging=!0;const n=s.getLocalPosition(e.parent);o.x=n.x-e.x,o.y=n.y-e.y,t.stopPropagation()}),e.on("pointerup",()=>{s&&s.dragging&&(e.alpha=1,s.dragging=!1,this.onObjectUpdated&&this.onObjectUpdated(t,{x:e.x,y:e.y}),s=null)}),e.on("pointermove",()=>{if(s&&s.dragging){const i=s.getLocalPosition(e.parent);e.x=i.x-o.x,e.y=i.y-o.y;const r=performance.now();r-n>=50&&(this.onObjectUpdated&&this.onObjectUpdated(t,{x:e.x,y:e.y}),n=r)}})}makeSelectable(e,t){e.on("click",e=>{"select"===this.currentTool&&(e.data.originalEvent.shiftKey?this.selectedObjects.has(t)?this.deselectObject(t):this.selectObject(t):(this.clearSelection(),this.selectObject(t)),e.stopPropagation())})}selectObject(e){const t=this.objects.get(e);if(!t)return;this.selectedObjects.add(e);const s=this.selectionIndicators.get(e);s&&(this.viewport.removeChild(s),s.destroy());const n=new o;if(n.lineStyle(2,65280),t.userData)if("rectangle"===t.userData.type){const{width:e,height:s}=t.userData;n.drawRect(-2,-2,e+4,s+4),n.x=t.x,n.y=t.y}else if("circle"===t.userData.type){const{radius:e}=t.userData;n.drawCircle(0,0,e+2),n.x=t.x,n.y=t.y}this.viewport.addChild(n),this.selectionIndicators.set(e,n)}deselectObject(e){if(!this.objects.get(e))return;this.selectedObjects.delete(e);const t=this.selectionIndicators.get(e);t&&(this.viewport.removeChild(t),t.destroy(),this.selectionIndicators.delete(e))}clearSelection(){this.selectedObjects.forEach(e=>this.deselectObject(e)),this.selectedObjects.clear()}deleteSelected(){this.selectedObjects.forEach(e=>{this.deleteObject(e),this.onObjectDeleted&&this.onObjectDeleted(e)}),this.selectedObjects.clear()}loadState(e){if(console.error("========================================"),console.error("=== LOAD STATE CALLED ==="),console.error("========================================"),console.error("Canvas state received:",e),console.error("Canvas state type:",typeof e),console.error("Is array?",Array.isArray(e)),console.error("Clearing existing objects..."),this.objects.forEach((e,t)=>{this.deleteObject(t)}),console.error("Objects cleared. Map size:",this.objects.size),e&&"object"==typeof e)if(Array.isArray(e))console.error(`=== Loading ${e.length} objects from ARRAY ===`),e.forEach((e,t)=>{console.error(`Loading object ${t}:`,JSON.stringify(e)),this.createRemoteObject(e)});else{const t=Object.values(e);console.error(`=== Loading ${t.length} objects from OBJECT ===`),t.forEach((e,t)=>{console.error(`Loading object ${t}:`,JSON.stringify(e)),this.createRemoteObject(e)})}else console.error("!!! INVALID canvas state !!!:",e);console.error("========================================"),console.error(`=== LOAD STATE COMPLETE: ${this.objects.size} objects ===`),console.error("Current objects in map:",Array.from(this.objects.keys())),console.error("========================================")}updateObject(e,t){const s=this.objects.get(e);s&&(void 0!==t.x&&(s.x=t.x),void 0!==t.y&&(s.y=t.y),s instanceof o&&(void 0===t.width&&void 0===t.height||console.log("Dimension updates for Graphics require recreation")))}deleteObject(e){const t=this.objects.get(e);if(t){this.viewport.removeChild(t),this.objects.delete(e),t.destroy();const s=this.selectionIndicators.get(e);s&&(this.viewport.removeChild(s),s.destroy(),this.selectionIndicators.delete(e)),this.selectedObjects.delete(e)}}createRemoteObject(e){console.log("Creating remote object:",e),console.log("Object properties:",{id:e.id,type:e.type,x:e.x,y:e.y,width:e.width,height:e.height,radius:e.radius,color:e.color,colorType:typeof e.color});const t=this.normalizeColor(e.color);console.log("Normalized color:",t,"type:",typeof t);let s=e.type;if(!s)if(console.warn("Object missing type field, inferring from properties:",e),void 0!==e.radius)s="circle";else if(void 0!==e.width&&void 0!==e.height)s="rectangle";else{if(void 0===e.text)return void console.error("Cannot infer type for object:",e);s="text"}if("rectangle"===s){if(!e.width||!e.height||e.width<=0||e.height<=0)return void console.warn("Skipping rectangle with invalid dimensions:",e);console.log("Creating rectangle with:",{id:e.id,x:e.x,y:e.y,width:e.width,height:e.height,color:t}),this.createRectangle(e.id,e.x,e.y,e.width,e.height,t),console.log("Rectangle created successfully. Objects in map:",this.objects.size)}else"circle"===s?(console.log("Creating circle with:",{id:e.id,x:e.x,y:e.y,radius:e.radius,color:t}),this.createCircle(e.id,e.x,e.y,e.radius,t),console.log("Circle created successfully")):"text"===s?(console.log("Creating text with:",{id:e.id,text:e.text,x:e.x,y:e.y,fontSize:e.fontSize,color:t}),this.createText(e.id,e.text,e.x,e.y,e.fontSize,t),console.log("Text created successfully")):console.error("Unknown object type:",s)}normalizeColor(e){return"number"==typeof e?e:"string"==typeof e?e.startsWith("#")?parseInt(e.substring(1),16):parseInt(e,16):3447003}updateRemoteObject(e,t){console.log("Updating remote object:",e,t),this.updateObject(e,t)}deleteRemoteObject(e){console.log("Deleting remote object:",e),this.deleteObject(e)}getObject(e){return this.objects.get(e)}getAllObjects(){return Array.from(this.objects.entries()).map(([e,t])=>({id:e,type:t.constructor.name,x:t.x,y:t.y}))}updateRemoteCursor(e,t,i,r,a){let c=this.remoteCursors.get(e);const l=a&&"string"==typeof a&&a.startsWith("#")?parseInt(a.substring(1),16):16739179;if(!c){c=new s;const i=new o;i.beginFill(l),i.moveTo(0,0),i.lineTo(12,18),i.lineTo(6,18),i.lineTo(0,24),i.endFill();const r=new n(t,{fontSize:12,fill:16777215,backgroundColor:l,padding:4});r.x=15,r.y=0,c.addChild(i),c.addChild(r),c.zIndex=1e3,this.remoteCursors.set(e,c),this.viewport.addChild(c)}c.x=i,c.y=r}removeRemoteCursor(e){const t=this.remoteCursors.get(e);t&&(this.viewport.removeChild(t),t.destroy(),this.remoteCursors.delete(e))}generateId(){return"obj-"+Math.random().toString(36).substr(2,9)}setColor(e){this.currentColor=e}getCanvasState(){const e=[];return this.objects.forEach((t,s)=>{e.push({id:s,type:t.constructor.name,x:t.x,y:t.y})}),{objects:e}}onObjectCreated=null;onObjectMoved=null;onObjectDeleted=null;onCursorMoved=null}class r{constructor(e,t,s){this.url=e,this.sessionId=t,this.canvasId=s,this.ws=null,this.isConnected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.lastCursorSend=0,this.cursorSendInterval=16,this.pendingCursor=null,this.cursorAnimationFrame=null,this.onAuthSuccess=()=>{},this.onAuthFailed=()=>{},this.onUserConnected=()=>{},this.onUserDisconnected=()=>{},this.onPresenceUpdate=()=>{},this.onCursorUpdate=()=>{},this.onObjectCreated=()=>{},this.onObjectUpdated=()=>{},this.onObjectDeleted=()=>{},this.onError=()=>{},this.onReconnecting=()=>{},this.onReconnected=()=>{}}connect(){console.log(`Connecting to WebSocket: ${this.url}`);try{this.ws=new WebSocket(this.url),this.setupEventHandlers()}catch(e){console.error("WebSocket connection error:",e),this.onError(e),this.scheduleReconnect()}}setupEventHandlers(){this.ws.onopen=()=>{console.log("WebSocket connected"),this.isConnected=!0,this.reconnectAttempts=0,this.send({type:"auth",sessionId:this.sessionId,canvasId:this.canvasId}),this.reconnectAttempts>0&&this.onReconnected()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(t){console.error("Error parsing WebSocket message:",t),this.onError(t)}},this.ws.onclose=e=>{console.log("WebSocket disconnected:",e.code,e.reason),this.isConnected=!1,e.wasClean||this.scheduleReconnect()},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.onError(e)}}handleMessage(e){switch(e.type){case"auth-success":this.onAuthSuccess(e);break;case"auth-failed":this.onAuthFailed(e);break;case"user-connected":this.onUserConnected(e);break;case"user-disconnected":this.onUserDisconnected(e);break;case"presence":this.onPresenceUpdate(e.users);break;case"cursor":this.onCursorUpdate(e);break;case"object-create":this.onObjectCreated(e);break;case"object-update":this.onObjectUpdated(e);break;case"object-delete":this.onObjectDeleted(e);break;case"error":console.error("Server error:",e.message),this.onError(new Error(e.message));break;default:console.warn("Unknown message type:",e.type)}}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("WebSocket not connected, message not sent:",e)}sendCursorUpdate(e,t){this.pendingCursor={x:e,y:t},this.cursorAnimationFrame||(this.cursorAnimationFrame=requestAnimationFrame(()=>{this.processCursorUpdate()}))}processCursorUpdate(){const e=performance.now();e-this.lastCursorSend>=this.cursorSendInterval&&this.pendingCursor?(this.send({type:"cursor",x:this.pendingCursor.x,y:this.pendingCursor.y}),this.lastCursorSend=e,this.pendingCursor=null,this.cursorAnimationFrame=null):this.pendingCursor?this.cursorAnimationFrame=requestAnimationFrame(()=>{this.processCursorUpdate()}):this.cursorAnimationFrame=null}sendObjectCreate(e){this.send({type:"object-create",object:e})}sendObjectUpdate(e,t){this.send({type:"object-update","object-id":e,updates:t})}sendObjectDelete(e){this.send({type:"object-delete","object-id":e})}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return console.error("Max reconnection attempts reached"),void this.onError(new Error("Unable to reconnect to server"));this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`Attempting to reconnect in ${e}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.onReconnecting(),setTimeout(()=>{this.connect()},e)}disconnect(){this.ws&&(this.ws.close(1e3,"User disconnect"),this.ws=null,this.isConnected=!1)}}class a{constructor(){this.modal=document.getElementById("auth-modal"),this.loginForm=document.getElementById("login-form"),this.registerForm=document.getElementById("register-form"),this.setupEventListeners()}setupEventListeners(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;this.switchTab(t)})}),this.loginForm.addEventListener("submit",async e=>{e.preventDefault(),await this.handleLogin()}),this.registerForm.addEventListener("submit",async e=>{e.preventDefault(),await this.handleRegister()})}switchTab(e){document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".auth-form").forEach(t=>{t.classList.toggle("active",t.id===`${e}-form`)}),document.querySelectorAll(".error-message").forEach(e=>{e.textContent=""})}showModal(){return new Promise(e=>{this.modal.classList.remove("hidden"),this.resolveAuth=e})}hideModal(){this.modal.classList.add("hidden")}async handleLogin(){const e=document.getElementById("login-email").value,t=document.getElementById("login-password").value,s=document.getElementById("login-error");try{const o=await fetch("/api/login",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),n=await o.json();n.success&&n.data?(this.hideModal(),this.resolveAuth({sessionId:n.data["session-id"],userId:n.data["user-id"],username:n.data.username})):s.textContent=n.error||"Login failed"}catch(o){console.error("Login error:",o),s.textContent="Connection error. Please try again."}}async handleRegister(){const e=document.getElementById("register-username").value,t=document.getElementById("register-email").value,s=document.getElementById("register-password").value,o=document.getElementById("register-error");try{const n=await fetch("/api/register",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,email:t,password:s})}),i=await n.json();i.success?await this.loginAfterRegister(t,s):o.textContent=i.error||"Registration failed"}catch(n){console.error("Registration error:",n),o.textContent="Connection error. Please try again."}}async loginAfterRegister(e,t){this.switchTab("login"),document.getElementById("login-email").value=e,document.getElementById("login-password").value=t,await this.handleLogin()}}class c{constructor(){this.canvasManager=null,this.wsClient=null,this.authManager=null,this.sessionId=null,this.userId=null,this.username=null,this.canvasId=this.getCanvasId(),this.activeUsers=[]}getCanvasId(){let e=new URLSearchParams(window.location.search).get("canvas");if(!e){e="default-canvas";const t=new URL(window.location);t.searchParams.set("canvas",e),window.history.replaceState({},"",t)}return e}async init(){if(console.log("Initializing CollabCanvas..."),document.getElementById("canvas-id").textContent=this.canvasId,this.authManager=new a,this.sessionId=localStorage.getItem("sessionId"),this.sessionId&&(await this.validateSession()||(this.sessionId=null,localStorage.removeItem("sessionId"))),!this.sessionId){this.hideLoadingScreen();const e=await this.authManager.showModal();this.sessionId=e.sessionId,this.userId=e.userId,this.username=e.username,localStorage.setItem("sessionId",this.sessionId)}this.hideLoadingScreen(),this.initCanvas(),this.initWebSocket(),this.setupUIHandlers(),console.log("CollabCanvas initialized successfully")}hideLoadingScreen(){const e=document.getElementById("loading-screen");e&&e.classList.add("hidden")}async validateSession(){try{const e=await fetch("/api/session",{credentials:"include",headers:{Authorization:this.sessionId}});if(e.ok){const t=await e.json();if(t.success&&t.data&&t.data.valid)return this.userId=t.data["user-id"],this.username=t.data.username,console.log("Session restored:",this.username),!0}}catch(e){console.error("Session validation failed:",e)}return!1}initCanvas(){const e=document.getElementById("canvas-container"),s=new i({width:window.innerWidth,height:window.innerHeight,backgroundColor:1710618,resizeTo:window});e.appendChild(s.view),this.canvasManager=new t(s),this.canvasManager.onCursorMoved=(e,t)=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendCursorUpdate(e,t)},this.canvasManager.onObjectCreated=e=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectCreate(e)},this.canvasManager.onObjectUpdated=(e,t)=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectUpdate(e,t)},this.canvasManager.onObjectDeleted=e=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectDelete(e)},this.canvasManager.onToolChange=e=>{document.getElementById("current-tool").textContent=e.charAt(0).toUpperCase()+e.slice(1)},this.canvasManager.onMouseMove=(e,t)=>{document.getElementById("mouse-position").textContent=`${Math.round(e)}, ${Math.round(t)}`},this.canvasManager.onZoomChange=e=>{document.getElementById("zoom-level").textContent=`${Math.round(100*e)}%`},this.canvasManager.onObjectCountChange=e=>{document.getElementById("object-count").textContent=e}}initWebSocket(){const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/${this.canvasId}`;this.wsClient=new r(e,this.sessionId,this.canvasId),this.wsClient.onAuthSuccess=e=>{console.error("=== WebSocket authenticated ==="),console.error("Auth data received:",e);const t=e["canvas-state"]||e.canvasState;console.error("canvasState exists?",!!t),console.error("canvasState type:",typeof t),console.error("canvasState length:",t?t.length:0),t?(console.error("=== CALLING loadState ==="),this.canvasManager.loadState(t),console.error("=== loadState RETURNED ===")):console.error("=== NO CANVAS STATE IN AUTH RESPONSE ===")},this.wsClient.onUserConnected=e=>{this.activeUsers.push({"user-id":e.userId||e["user-id"],username:e.username,color:e.color}),this.updatePresenceList(this.activeUsers),this.showNotification(`${e.username} joined`,"info")},this.wsClient.onUserDisconnected=e=>{const t=e.userId||e["user-id"];this.activeUsers=this.activeUsers.filter(e=>(e["user-id"]||e.userId)!==t),this.updatePresenceList(this.activeUsers),this.canvasManager.removeRemoteCursor(t),this.showNotification(`${e.username} left`,"info")},this.wsClient.onPresenceUpdate=e=>{this.activeUsers=e,this.updatePresenceList(this.activeUsers)},this.wsClient.onCursorUpdate=e=>{this.canvasManager.updateRemoteCursor(e.userId,e.username,e.x,e.y,e.color)},this.wsClient.onObjectCreated=e=>{this.canvasManager.createRemoteObject(e.object)},this.wsClient.onObjectUpdated=e=>{const t=e["object-id"]||e.objectId;this.canvasManager.updateRemoteObject(t,e.updates)},this.wsClient.onObjectDeleted=e=>{const t=e["object-id"]||e.objectId;this.canvasManager.deleteRemoteObject(t)},this.wsClient.onError=e=>{console.error("WebSocket error:",e),this.showNotification("Connection error","error")},this.wsClient.onReconnecting=()=>{this.showNotification("Reconnecting...","warning")},this.wsClient.onReconnected=()=>{this.showNotification("Reconnected","success")},this.wsClient.connect()}setupUIHandlers(){document.querySelectorAll(".tool-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tool;this.canvasManager.setTool(t),document.querySelectorAll(".tool-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active")})}),document.getElementById("color-picker").addEventListener("change",e=>{this.canvasManager.setColor(e.target.value)}),document.addEventListener("keydown",e=>{if("INPUT"!==e.target.tagName)switch(e.key.toLowerCase()){case"v":this.selectTool("select");break;case"r":this.selectTool("rectangle");break;case"c":this.selectTool("circle");break;case"delete":case"backspace":e.target.isContentEditable||(e.preventDefault(),this.canvasManager.deleteSelected());break;case"z":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.shiftKey?this.canvasManager.redo():this.canvasManager.undo())}});const e=document.getElementById("logout-btn");e&&e.addEventListener("click",async()=>{await this.logout()})}selectTool(e){this.canvasManager.setTool(e),document.querySelectorAll(".tool-btn").forEach(t=>{t.dataset.tool===e?t.classList.add("active"):t.classList.remove("active")})}updatePresenceList(e=[]){const t=document.getElementById("users-container");t.innerHTML="",e.forEach(e=>{const s=document.createElement("div");s.className="user-item";const o=e.username,n=e.color;s.innerHTML=`\n                <span class="user-indicator" style="background-color: ${n}"></span>\n                <span>${o}</span>\n            `,t.appendChild(s)})}showNotification(e,t="info"){console.log(`[${t.toUpperCase()}] ${e}`)}async logout(){try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.sessionId}})}catch(e){console.error("Logout error:",e)}localStorage.removeItem("sessionId"),this.wsClient.disconnect(),window.location.reload()}}if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{const e=new c;e.init(),window.collabCanvas=e});else{const e=new c;e.init(),window.collabCanvas=e}}}});
//# sourceMappingURL=index-legacy-D3NQiwmV.js.map

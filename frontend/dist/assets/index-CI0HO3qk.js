var w=Object.defineProperty;var v=(c,e,t)=>e in c?w(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var d=(c,e,t)=>v(c,typeof e!="symbol"?e+"":e,t);import{C as p,G as l,S as b,T as y,a as f,B as C,b as x,A as S}from"./pixi-y1-bY_3d.js";function k(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class M{constructor(e,t){this.app=e,this.canvasManager=t,this.fpsHistory=[],this.maxHistorySize=60,this.currentFps=60,this.lastTime=performance.now(),this.frameCount=0,this.app.ticker.add(this.update.bind(this)),console.log("PerformanceMonitor initialized")}update(e){const t=performance.now(),s=t-this.lastTime;if(s>0&&(this.currentFps=Math.round(1e3/s)),this.lastTime=t,this.fpsHistory.push(this.currentFps),this.fpsHistory.length>this.maxHistorySize&&this.fpsHistory.shift(),this.currentFps<55){const n=this.getAverageFps(),i=this.canvasManager?this.canvasManager.objects.size:0;console.warn("⚠️ Low FPS detected: ".concat(this.currentFps," FPS (avg: ").concat(n.toFixed(1),", objects: ").concat(i,")"))}}getAverageFps(){return this.fpsHistory.length===0?60:this.fpsHistory.reduce((t,s)=>t+s,0)/this.fpsHistory.length}getStats(){return this.fpsHistory.length===0?{current:this.currentFps,average:60,min:60,max:60}:{current:this.currentFps,average:Math.round(this.getAverageFps()*10)/10,min:Math.min(...this.fpsHistory),max:Math.max(...this.fpsHistory)}}destroy(){this.app&&this.app.ticker&&this.app.ticker.remove(this.update.bind(this))}}class I{constructor(e){d(this,"onObjectCreated",null);d(this,"onObjectMoved",null);d(this,"onObjectDeleted",null);d(this,"onCursorMoved",null);this.app=e,this.viewport=new p,this.objects=new Map,this.selectedObjects=new Set,this.selectionIndicators=new Map,this.remoteCursors=new Map,this.isPanning=!1,this.panStart={x:0,y:0},this.currentTool="select",this.currentColor=3447003,this.cullingEnabled=!0,this.cullingPadding=200,this.lastViewportBounds=null,this.performanceMonitor=new M(e,this),this.cursorTexture=this.createSharedCursorTexture(),this.app.stage.addChild(this.viewport),this.viewport.sortableChildren=!0,this.drawGrid(),this.setupPanZoom(),this.setupKeyboardShortcuts(),this.setupToolHandlers(),this.setupViewportCulling(),console.log("Canvas initialized")}createSharedCursorTexture(){const e=new l;e.beginFill(16777215),e.moveTo(0,0),e.lineTo(12,18),e.lineTo(6,18),e.lineTo(0,24),e.endFill();const t=this.app.renderer.generateTexture(e,{resolution:1,scaleMode:b.LINEAR});return e.destroy(),t}drawGrid(){const e=new l;e.lineStyle(1,3355443,.3);const t=50,s=5e3;for(let n=-s;n<=s;n+=t)e.moveTo(n,-s),e.lineTo(n,s);for(let n=-s;n<=s;n+=t)e.moveTo(-s,n),e.lineTo(s,n);e.zIndex=-1,this.viewport.addChild(e)}setupPanZoom(){const e=this.app.view;e.addEventListener("mousedown",t=>{(t.button===1||t.button===0&&t.altKey)&&(this.isPanning=!0,this.panStart={x:t.clientX,y:t.clientY},e.style.cursor="grabbing",t.preventDefault())}),e.addEventListener("mousemove",t=>{if(this.isPanning){const s=t.clientX-this.panStart.x,n=t.clientY-this.panStart.y;this.viewport.x+=s,this.viewport.y+=n,this.panStart={x:t.clientX,y:t.clientY}}}),e.addEventListener("mouseup",()=>{this.isPanning&&(this.isPanning=!1,e.style.cursor="default")}),e.addEventListener("wheel",t=>{t.preventDefault();const s=t.deltaY>0?.9:1.1,n=t.clientX,i=t.clientY,o=this.screenToWorld(n,i),r=this.viewport.scale.x*s;if(r>=.1&&r<=10){this.viewport.scale.set(r);const a=this.screenToWorld(n,i);this.viewport.x+=(a.x-o.x)*this.viewport.scale.x,this.viewport.y+=(a.y-o.y)*this.viewport.scale.y}},{passive:!1})}screenToWorld(e,t){return{x:(e-this.viewport.x)/this.viewport.scale.x,y:(t-this.viewport.y)/this.viewport.scale.y}}worldToScreen(e,t){return{x:e*this.viewport.scale.x+this.viewport.x,y:t*this.viewport.scale.y+this.viewport.y}}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{e.key==="r"||e.key==="R"?this.setTool("rectangle"):e.key==="c"||e.key==="C"?this.setTool("circle"):e.key==="t"||e.key==="T"?this.setTool("text"):e.key==="v"||e.key==="V"||e.key==="Escape"?this.setTool("select"):(e.key==="Delete"||e.key==="Backspace")&&this.deleteSelected()})}setTool(e){this.currentTool=e,console.log("Tool:",e)}setupToolHandlers(){const e=this.app.view;let t=null,s=null;e.addEventListener("mousemove",n=>{const i=this.screenToWorld(n.clientX,n.clientY);if(this.onCursorMoved&&this.onCursorMoved(i.x,i.y),t&&s){const o=i.x-t.x,r=i.y-t.y;if(s.clear(),s.beginFill(this.currentColor),this.currentTool==="rectangle")s.drawRect(t.x,t.y,o,r);else if(this.currentTool==="circle"){const a=Math.sqrt(o*o+r*r);s.drawCircle(t.x,t.y,a)}s.endFill()}}),e.addEventListener("mousedown",n=>{if(n.button!==0||n.altKey)return;const i=this.screenToWorld(n.clientX,n.clientY);(this.currentTool==="rectangle"||this.currentTool==="circle")&&(t=i,s=new l,s.alpha=.5,this.viewport.addChild(s))}),e.addEventListener("mouseup",n=>{if(t&&s){const i=this.screenToWorld(n.clientX,n.clientY),o=this.createToolObject(t,i);this.viewport.removeChild(s),s=null,t=null,this.onObjectCreated&&this.onObjectCreated(o)}})}setupViewportCulling(){this.app.ticker.add(()=>{this.cullingEnabled&&this.updateVisibleObjects()})}updateVisibleObjects(){const e=this.getViewportBounds();(!this.lastViewportBounds||Math.abs(e.left-this.lastViewportBounds.left)>50||Math.abs(e.top-this.lastViewportBounds.top)>50||Math.abs(e.right-this.lastViewportBounds.right)>50||Math.abs(e.bottom-this.lastViewportBounds.bottom)>50)&&(this.lastViewportBounds=e,this.objects.forEach((t,s)=>{const n=this.getObjectBounds(t),i=this.isBoundsVisible(n,e);t.visible!==i&&(t.visible=i)}))}getViewportBounds(){const e=this.app.renderer.width,t=this.app.renderer.height,s=this.screenToWorld(0,0),n=this.screenToWorld(e,t);return{left:s.x-this.cullingPadding,top:s.y-this.cullingPadding,right:n.x+this.cullingPadding,bottom:n.y+this.cullingPadding}}getObjectBounds(e){if(e.userData){if(e.userData.type==="rectangle")return{left:e.x,top:e.y,right:e.x+e.userData.width,bottom:e.y+e.userData.height};if(e.userData.type==="circle"){const t=e.userData.radius;return{left:e.x-t,top:e.y-t,right:e.x+t,bottom:e.y+t}}}return e.width&&e.height?{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height}:{left:e.x,top:e.y,right:e.x,bottom:e.y}}isBoundsVisible(e,t){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)}createToolObject(e,t){const s=this.generateId();if(this.currentTool==="rectangle"){const n=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y),o=Math.min(e.x,t.x),r=Math.min(e.y,t.y);return this.createRectangle(s,o,r,n,i,this.currentColor),{id:s,type:"rectangle",x:o,y:r,width:n,height:i,color:this.currentColor}}else if(this.currentTool==="circle"){const n=t.x-e.x,i=t.y-e.y,o=Math.sqrt(n*n+i*i);return this.createCircle(s,e.x,e.y,o,this.currentColor),{id:s,type:"circle",x:e.x,y:e.y,radius:o,color:this.currentColor}}}createRectangle(e,t,s,n,i,o){const r=new l;return r.beginFill(o),r.drawRect(0,0,n,i),r.endFill(),r.x=t,r.y=s,r.interactive=!0,r.buttonMode=!0,r.visible=!0,r.userData={width:n,height:i,type:"rectangle"},this.makeDraggable(r,e),this.makeSelectable(r,e),this.objects.set(e,r),this.viewport.addChild(r),r}createCircle(e,t,s,n,i){const o=new l;return o.beginFill(i),o.drawCircle(0,0,n),o.endFill(),o.x=t,o.y=s,o.interactive=!0,o.buttonMode=!0,o.visible=!0,o.userData={radius:n,type:"circle"},this.makeDraggable(o,e),this.makeSelectable(o,e),this.objects.set(e,o),this.viewport.addChild(o),o}createText(e,t,s,n,i,o){const r=new y(t,{fontSize:i,fill:o,fontFamily:"Arial"});return r.x=s,r.y=n,r.interactive=!0,r.buttonMode=!0,r.visible=!0,this.makeDraggable(r,e),this.makeSelectable(r,e),this.objects.set(e,r),this.viewport.addChild(r),r}makeDraggable(e,t){let s=null,n={x:0,y:0},i=0;const o=50;e.on("pointerdown",r=>{if(this.currentTool!=="select")return;s=r.data,e.alpha=.7,s.dragging=!0;const a=s.getLocalPosition(e.parent);n.x=a.x-e.x,n.y=a.y-e.y,r.stopPropagation()}),e.on("pointerup",()=>{s&&s.dragging&&(e.alpha=1,s.dragging=!1,this.onObjectUpdated&&this.onObjectUpdated(t,{x:e.x,y:e.y}),s=null)}),e.on("pointermove",()=>{if(s&&s.dragging){const r=s.getLocalPosition(e.parent);e.x=r.x-n.x,e.y=r.y-n.y;const a=performance.now();a-i>=o&&(this.onObjectUpdated&&this.onObjectUpdated(t,{x:e.x,y:e.y}),i=a)}})}makeSelectable(e,t){e.on("click",s=>{this.currentTool==="select"&&(s.data.originalEvent.shiftKey?this.selectedObjects.has(t)?this.deselectObject(t):this.selectObject(t):(this.clearSelection(),this.selectObject(t)),s.stopPropagation())})}selectObject(e){const t=this.objects.get(e);if(!t)return;this.selectedObjects.add(e);const s=this.selectionIndicators.get(e);s&&(this.viewport.removeChild(s),s.destroy());const n=new l;if(n.lineStyle(2,65280),t.userData){if(t.userData.type==="rectangle"){const{width:i,height:o}=t.userData;n.drawRect(-2,-2,i+4,o+4),n.x=t.x,n.y=t.y}else if(t.userData.type==="circle"){const{radius:i}=t.userData;n.drawCircle(0,0,i+2),n.x=t.x,n.y=t.y}}this.viewport.addChild(n),this.selectionIndicators.set(e,n)}deselectObject(e){if(!this.objects.get(e))return;this.selectedObjects.delete(e);const s=this.selectionIndicators.get(e);s&&(this.viewport.removeChild(s),s.destroy(),this.selectionIndicators.delete(e))}clearSelection(){this.selectedObjects.forEach(e=>this.deselectObject(e)),this.selectedObjects.clear()}deleteSelected(){if(this.selectedObjects.size===0)return;const e=Array.from(this.selectedObjects),t=this.deleteObjects(e);this.selectedObjects.clear(),this.onObjectsDeleted&&t.length>0&&this.onObjectsDeleted(t),console.log("Deleted ".concat(t.length," selected objects"))}loadState(e){if(console.error("========================================"),console.error("=== LOAD STATE CALLED ==="),console.error("========================================"),console.error("Canvas state received:",e),console.error("Canvas state type:",typeof e),console.error("Is array?",Array.isArray(e)),console.error("Clearing existing objects..."),this.objects.forEach((t,s)=>{this.deleteObject(s)}),console.error("Objects cleared. Map size:",this.objects.size),e&&typeof e=="object")if(Array.isArray(e))console.error("=== Loading ".concat(e.length," objects from ARRAY ===")),e.forEach((t,s)=>{console.error("Loading object ".concat(s,":"),JSON.stringify(t)),this.createRemoteObject(t)});else{const t=Object.values(e);console.error("=== Loading ".concat(t.length," objects from OBJECT ===")),t.forEach((s,n)=>{console.error("Loading object ".concat(n,":"),JSON.stringify(s)),this.createRemoteObject(s)})}else console.error("!!! INVALID canvas state !!!:",e);console.error("========================================"),console.error("=== LOAD STATE COMPLETE: ".concat(this.objects.size," objects ===")),console.error("Current objects in map:",Array.from(this.objects.keys())),console.error("========================================"),this.cullingEnabled&&this.updateVisibleObjects()}applyDelta(e,t){const s=this.objects.get(e);if(s){for(const[n,i]of Object.entries(t))s[n]=i;s instanceof l&&(t.width!==void 0||t.height!==void 0||t.color!==void 0||t.rotation!==void 0)&&this.redrawGraphicsObject(s)}}redrawGraphicsObject(e){e.clear(),e.width&&e.height&&(e.beginFill(e.color||16711680),e.drawRect(0,0,e.width,e.height),e.endFill()),e.rotation&&(e.rotation=e.rotation)}updateObject(e,t){const s=this.objects.get(e);s&&(t.x!==void 0&&(s.x=t.x),t.y!==void 0&&(s.y=t.y),s instanceof l&&(t.width!==void 0||t.height!==void 0)&&console.log("Dimension updates for Graphics require recreation"))}deleteObject(e){const t=this.objects.get(e);if(t){this.viewport.removeChild(t),this.objects.delete(e),t.destroy({children:!0,texture:!1,baseTexture:!1});const s=this.selectionIndicators.get(e);s&&(this.viewport.removeChild(s),s.destroy({children:!0,texture:!1,baseTexture:!1}),this.selectionIndicators.delete(e)),this.selectedObjects.delete(e),console.log("Deleted object ".concat(e," with proper texture preservation"))}}deleteObjects(e){if(!Array.isArray(e)||e.length===0){console.warn("deleteObjects: Expected non-empty array of IDs");return}console.log("Bulk deleting ".concat(e.length," objects:"),e);const t=[];return e.forEach(s=>{const n=this.objects.get(s);if(n){this.viewport.removeChild(n),this.objects.delete(s),n.destroy({children:!0,texture:!1,baseTexture:!1});const i=this.selectionIndicators.get(s);i&&(this.viewport.removeChild(i),i.destroy({children:!0,texture:!1,baseTexture:!1}),this.selectionIndicators.delete(s)),this.selectedObjects.delete(s),t.push(s)}else console.warn("Object ".concat(s," not found for deletion"))}),console.log("Bulk deleted ".concat(t.length," objects successfully")),t}verifyObjectDeletion(e){Array.isArray(e)||(e=[e]);let t=!0;const s=[];e.forEach(o=>{this.objects.has(o)&&(s.push("Object ".concat(o," still in objects map")),t=!1),this.selectionIndicators.has(o)&&(s.push("Selection indicator for ".concat(o," still exists")),t=!1),this.selectedObjects.has(o)&&(s.push("Object ".concat(o," still in selectedObjects set")),t=!1),this.viewport.children.find(a=>a._objectId===o)&&(s.push("Object ".concat(o," still in viewport children")),t=!1)});const n=this.viewport.children.filter(o=>o._objectId&&!this.objects.has(o._objectId));n.length>0&&(s.push("".concat(n.length," orphaned PIXI objects found in viewport")),t=!1);const i=Object.keys(f).length;return i>100&&s.push("High texture count detected: ".concat(i," textures in cache")),t?console.log("Memory leak verification passed for ".concat(e.length," deleted objects")):console.warn("Memory leak verification failed:",s),{success:t,issues:s,textureCount:i,orphanedObjects:n.length}}getMemoryStats(){const e=this.viewport.children.length,t=this.objects.size,s=this.selectionIndicators.size,n=this.selectedObjects.size,i=this.remoteCursors.size;return{pixiChildren:e,objectsInMap:t,selectionIndicators:s,selectedObjects:n,remoteCursors:i,totalTrackedObjects:t+s+n+i,textureCacheSize:Object.keys(f).length,baseTextureCacheSize:Object.keys(C).length}}createRemoteObject(e){console.log("Creating remote object:",e),console.log("Object properties:",{id:e.id,type:e.type,x:e.x,y:e.y,width:e.width,height:e.height,radius:e.radius,color:e.color,colorType:typeof e.color});const t=this.normalizeColor(e.color);console.log("Normalized color:",t,"type:",typeof t);let s=e.type;if(!s)if(console.warn("Object missing type field, inferring from properties:",e),e.radius!==void 0)s="circle";else if(e.width!==void 0&&e.height!==void 0)s="rectangle";else if(e.text!==void 0)s="text";else{console.error("Cannot infer type for object:",e);return}if(s==="rectangle"){if(!e.width||!e.height||e.width<=0||e.height<=0){console.warn("Skipping rectangle with invalid dimensions:",e);return}console.log("Creating rectangle with:",{id:e.id,x:e.x,y:e.y,width:e.width,height:e.height,color:t}),this.createRectangle(e.id,e.x,e.y,e.width,e.height,t),console.log("Rectangle created successfully. Objects in map:",this.objects.size)}else s==="circle"?(console.log("Creating circle with:",{id:e.id,x:e.x,y:e.y,radius:e.radius,color:t}),this.createCircle(e.id,e.x,e.y,e.radius,t),console.log("Circle created successfully")):s==="text"?(console.log("Creating text with:",{id:e.id,text:e.text,x:e.x,y:e.y,fontSize:e.fontSize,color:t}),this.createText(e.id,e.text,e.x,e.y,e.fontSize,t),console.log("Text created successfully")):console.error("Unknown object type:",s)}normalizeColor(e){return typeof e=="number"?e:typeof e=="string"?e.startsWith("#")?parseInt(e.substring(1),16):parseInt(e,16):3447003}updateRemoteObject(e,t){console.log("Updating remote object with delta:",e,t),this.applyDelta(e,t)}deleteRemoteObject(e){console.log("Deleting remote object:",e),this.deleteObject(e)}getObject(e){return this.objects.get(e)}getAllObjects(){return Array.from(this.objects.entries()).map(([e,t])=>({id:e,type:t.constructor.name,x:t.x,y:t.y}))}getPerformanceStats(){return this.performanceMonitor.getStats()}updateRemoteCursor(e,t,s,n,i){let o=this.remoteCursors.get(e);const r=i&&typeof i=="string"&&i.startsWith("#")?parseInt(i.substring(1),16):16739179;if(!o){o=new p;const h=new x(this.cursorTexture);h.tint=r;const g=new y(t,{fontSize:12,fill:16777215,fontWeight:"bold",stroke:r,strokeThickness:2,dropShadow:!0,dropShadowColor:0,dropShadowAlpha:.7,dropShadowDistance:1});g.x=15,g.y=-5,o.addChild(h),o.addChild(g),o.zIndex=1e3,this.remoteCursors.set(e,o),this.viewport.addChild(o)}o.lastUpdate||(o.lastUpdate={x:s,y:n,time:performance.now()});const a=performance.now(),u=a-o.lastUpdate.time;if(u>0&&u<100){const h=Math.min(u/100,1);o.x=o.lastUpdate.x+(s-o.lastUpdate.x)*h,o.y=o.lastUpdate.y+(n-o.lastUpdate.y)*h}else o.x=s,o.y=n;o.lastUpdate={x:s,y:n,time:a}}removeRemoteCursor(e){const t=this.remoteCursors.get(e);t&&(this.viewport.removeChild(t),t.destroy(),this.remoteCursors.delete(e))}clearAllRemoteCursors(){console.log("Clearing all remote cursors (".concat(this.remoteCursors.size," cursors)")),this.remoteCursors.forEach((e,t)=>{this.viewport.removeChild(e),e.destroy()}),this.remoteCursors.clear(),console.log("All remote cursors cleared")}startPeriodicCleanup(e=6e4){this.cleanupInterval=setInterval(()=>{this.performCleanup()},e),console.log("Started periodic cleanup (every ".concat(e/1e3,"s)"))}stopPeriodicCleanup(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null,console.log("Stopped periodic cleanup"))}performCleanup(){console.log("=== Performing periodic cleanup ===");let e=0,t=0;this.selectionIndicators.forEach((n,i)=>{this.objects.has(i)||(this.viewport.removeChild(n),n.destroy(),this.selectionIndicators.delete(i),e++)}),this.selectedObjects.forEach(n=>{this.objects.has(n)||this.selectedObjects.delete(n)});const s=performance.now()-5*60*1e3;this.remoteCursors.forEach((n,i)=>{n.lastUpdate&&n.lastUpdate.time<s&&(this.removeRemoteCursor(i),t++)}),e>0||t>0?console.log("Cleanup complete: ".concat(e," indicators, ").concat(t," cursors removed")):console.log("Cleanup complete: No orphaned objects found")}generateId(){return"obj-"+Math.random().toString(36).substr(2,9)}setColor(e){this.currentColor=e}getCanvasState(){const e=[];return this.objects.forEach((t,s)=>{e.push({id:s,type:t.constructor.name,x:t.x,y:t.y})}),{objects:e}}destroy(){this.performanceMonitor&&this.performanceMonitor.destroy(),this.cursorTexture&&this.cursorTexture.destroy(),this.objects.forEach(e=>{e&&typeof e.destroy=="function"&&e.destroy()}),this.objects.clear(),this.selectionIndicators.forEach(e=>{e&&typeof e.destroy=="function"&&e.destroy()}),this.selectionIndicators.clear(),this.remoteCursors.forEach(e=>{e&&typeof e.destroy=="function"&&e.destroy()}),this.remoteCursors.clear()}}class O{constructor(e={}){this.maxHistorySize=e.maxHistorySize||1e3,this.warningThreshold=e.warningThreshold||100,this.pendingMessages=new Map,this.latencyHistory=[],this.stats={totalMessages:0,averageLatency:0,minLatency:1/0,maxLatency:0,warningCount:0}}startTracking(e,t){this.pendingMessages.set(e,{sentTime:performance.now(),type:t})}endTracking(e){const t=this.pendingMessages.get(e);if(!t)return null;const s=performance.now()-t.sentTime;return this.pendingMessages.delete(e),this.recordLatency(s,t.type),s>this.warningThreshold&&(console.warn("⚠️ High latency detected: ".concat(Math.round(s),"ms for ").concat(t.type," message")),this.stats.warningCount++),s}recordLatency(e,t){this.latencyHistory.push({latency:e,type:t,timestamp:Date.now()}),this.latencyHistory.length>this.maxHistorySize&&this.latencyHistory.shift(),this.stats.totalMessages++,this.stats.minLatency=Math.min(this.stats.minLatency,e),this.stats.maxLatency=Math.max(this.stats.maxLatency,e);const s=this.latencyHistory.reduce((n,i)=>n+i.latency,0);this.stats.averageLatency=s/this.latencyHistory.length}getPercentile(e){if(this.latencyHistory.length===0)return 0;const t=this.latencyHistory.map(n=>n.latency).sort((n,i)=>n-i),s=Math.ceil(e/100*t.length)-1;return t[Math.max(0,s)]}getStats(){return{totalMessages:this.stats.totalMessages,averageLatency:Math.round(this.stats.averageLatency*100)/100,minLatency:this.stats.minLatency===1/0?0:Math.round(this.stats.minLatency*100)/100,maxLatency:Math.round(this.stats.maxLatency*100)/100,p50:Math.round(this.getPercentile(50)*100)/100,p95:Math.round(this.getPercentile(95)*100)/100,p99:Math.round(this.getPercentile(99)*100)/100,warningCount:this.stats.warningCount,historySize:this.latencyHistory.length,pendingMessages:this.pendingMessages.size}}getStatsByType(e){const t=this.latencyHistory.filter(o=>o.type===e);if(t.length===0)return null;const s=t.map(o=>o.latency).sort((o,r)=>o-r),n=s.reduce((o,r)=>o+r,0),i=o=>{const r=Math.ceil(o/100*s.length)-1;return s[Math.max(0,r)]};return{messageType:e,count:t.length,averageLatency:Math.round(n/t.length*100)/100,minLatency:Math.round(s[0]*100)/100,maxLatency:Math.round(s[s.length-1]*100)/100,p50:Math.round(i(50)*100)/100,p95:Math.round(i(95)*100)/100,p99:Math.round(i(99)*100)/100}}logStats(){const e=this.getStats();console.log("=== Latency Statistics ==="),console.log("Total messages: ".concat(e.totalMessages)),console.log("Average latency: ".concat(e.averageLatency,"ms")),console.log("Min latency: ".concat(e.minLatency,"ms")),console.log("Max latency: ".concat(e.maxLatency,"ms")),console.log("P50 (median): ".concat(e.p50,"ms")),console.log("P95: ".concat(e.p95,"ms")),console.log("P99: ".concat(e.p99,"ms")),console.log("High latency warnings: ".concat(e.warningCount)),console.log("History size: ".concat(e.historySize)),console.log("Pending messages: ".concat(e.pendingMessages))}reset(){this.pendingMessages.clear(),this.latencyHistory=[],this.stats={totalMessages:0,averageLatency:0,minLatency:1/0,maxLatency:0,warningCount:0}}}class T{constructor(e,t=50){this.sendCallback=e,this.intervalMs=t,this.pendingCursor=null,this.intervalId=null,this.start()}start(){this.intervalId=setInterval(()=>{this.pendingCursor&&(this.sendCallback(this.pendingCursor.x,this.pendingCursor.y),this.pendingCursor=null)},this.intervalMs)}update(e,t){this.pendingCursor={x:e,y:t}}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}}class L{constructor(e,t,s){this.url=e,this.sessionId=t,this.canvasId=s,this.ws=null,this.isConnected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.messageIdCounter=0,this.latencyMonitor=new O({maxHistorySize:1e3,warningThreshold:100}),this.bandwidthStats={totalBytesReceived:0,objectUpdateMessages:0,startTime:Date.now()},this.cursorThrottle=new T((n,i)=>{this.send({type:"cursor",x:n,y:i})}),this.onAuthSuccess=()=>{},this.onAuthFailed=()=>{},this.onUserConnected=()=>{},this.onUserDisconnected=()=>{},this.onPresenceUpdate=()=>{},this.onCursorUpdate=()=>{},this.onObjectCreated=()=>{},this.onObjectUpdated=()=>{},this.onObjectDeleted=()=>{},this.onObjectsDeleted=()=>{},this.onError=()=>{},this.onReconnecting=()=>{},this.onReconnected=()=>{}}connect(){console.log("Connecting to WebSocket: ".concat(this.url));try{this.ws=new WebSocket(this.url),this.setupEventHandlers()}catch(e){console.error("WebSocket connection error:",e),this.onError(e),this.scheduleReconnect()}}setupEventHandlers(){this.ws.onopen=()=>{console.log("WebSocket connected"),this.isConnected=!0,this.reconnectAttempts=0,this.send({type:"auth",sessionId:this.sessionId,canvasId:this.canvasId}),this.reconnectAttempts>0&&this.onReconnected()},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(t){console.error("Error parsing WebSocket message:",t),this.onError(t)}},this.ws.onclose=e=>{console.log("WebSocket disconnected:",e.code,e.reason),this.isConnected=!1,e.wasClean||this.scheduleReconnect()},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.onError(e)}}handleMessage(e){if(e.messageId){const t=this.latencyMonitor.endTracking(e.messageId);t!==null&&t<100&&console.debug("Message ".concat(e.type," latency: ").concat(Math.round(t),"ms"))}switch(e.type){case"auth-success":this.onAuthSuccess(e);break;case"auth-failed":this.onAuthFailed(e);break;case"user-connected":this.onUserConnected(e);break;case"user-disconnected":this.onUserDisconnected(e);break;case"presence":this.onPresenceUpdate(e.users);break;case"cursor":this.onCursorUpdate(e);break;case"cursor-batch":e.cursors&&Array.isArray(e.cursors)&&e.cursors.forEach(s=>{this.onCursorUpdate(s)});break;case"object-create":this.onObjectCreated(e);break;case"object-update":const t=JSON.stringify(e).length;this.bandwidthStats.totalBytesReceived+=t,this.bandwidthStats.objectUpdateMessages++,console.log("Object update received: ".concat(t," bytes (total: ").concat(this.bandwidthStats.totalBytesReceived," bytes, ").concat(this.bandwidthStats.objectUpdateMessages," messages)")),this.onObjectUpdated(e);break;case"object-delete":this.onObjectDeleted(e);break;case"objects-delete":this.onObjectsDeleted(e);break;case"error":console.error("Server error:",e.message),this.onError(new Error(e.message));break;default:console.warn("Unknown message type:",e.type)}}send(e,t=!1){this.ws&&this.ws.readyState===WebSocket.OPEN?(t&&e.type!=="cursor"&&(e.messageId=++this.messageIdCounter,this.latencyMonitor.startTracking(e.messageId,e.type)),this.ws.send(JSON.stringify(e))):console.warn("WebSocket not connected, message not sent:",e)}sendCursorUpdate(e,t){this.cursorThrottle.update(e,t)}sendObjectCreate(e){this.send({type:"object-create",object:e},!0)}sendObjectUpdate(e,t){this.send({type:"object-update","object-id":e,updates:t},!0)}sendObjectDelete(e){this.send({type:"object-delete","object-id":e},!0)}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached"),this.onError(new Error("Unable to reconnect to server"));return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log("Attempting to reconnect in ".concat(e,"ms (attempt ").concat(this.reconnectAttempts,"/").concat(this.maxReconnectAttempts,")")),this.onReconnecting(),setTimeout(()=>{this.connect()},e)}getBandwidthStats(){const e=(Date.now()-this.bandwidthStats.startTime)/6e4;return{totalBytes:this.bandwidthStats.totalBytesReceived,messageCount:this.bandwidthStats.objectUpdateMessages,averageBytesPerMessage:this.bandwidthStats.objectUpdateMessages>0?Math.round(this.bandwidthStats.totalBytesReceived/this.bandwidthStats.objectUpdateMessages):0,bytesPerMinute:e>0?Math.round(this.bandwidthStats.totalBytesReceived/e):0,elapsedMinutes:Math.round(e*10)/10}}getLatencyStats(){return this.latencyMonitor.getStats()}getLatencyStatsByType(e){return this.latencyMonitor.getStatsByType(e)}logLatencyStats(){this.latencyMonitor.logStats()}logBandwidthStats(){const e=this.getBandwidthStats();console.log("Bandwidth Stats (Delta Compression):",{"Total bytes received":"".concat(e.totalBytes," bytes"),"Object update messages":e.messageCount,"Avg bytes per message":"".concat(e.averageBytesPerMessage," bytes"),"Bytes per minute":"".concat(e.bytesPerMinute," bytes/min"),"Elapsed time":"".concat(e.elapsedMinutes," minutes")})}disconnect(){this.bandwidthStats.objectUpdateMessages>0&&(console.log("=== Final Bandwidth Stats (Delta Compression) ==="),this.logBandwidthStats()),this.cursorThrottle&&(this.cursorThrottle.stop(),console.log("Stopped cursor throttle timer")),this.ws&&(this.ws.close(1e3,"User disconnect"),this.ws=null,this.isConnected=!1),console.log("=== Disconnect cleanup complete ===")}sendObjectsDelete(e){this.send({type:"objects-delete","object-ids":e})}sendObjectsDelete(e){this.send({type:"objects-delete","object-ids":e})}}class E{constructor(){this.modal=document.getElementById("auth-modal"),this.loginForm=document.getElementById("login-form"),this.registerForm=document.getElementById("register-form"),this.setupEventListeners()}setupEventListeners(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;this.switchTab(t)})}),this.loginForm.addEventListener("submit",async e=>{e.preventDefault(),await this.handleLogin()}),this.registerForm.addEventListener("submit",async e=>{e.preventDefault(),await this.handleRegister()})}switchTab(e){document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".auth-form").forEach(t=>{t.classList.toggle("active",t.id==="".concat(e,"-form"))}),document.querySelectorAll(".error-message").forEach(t=>{t.textContent=""})}showModal(){return new Promise(e=>{this.modal.classList.remove("hidden"),this.resolveAuth=e})}hideModal(){this.modal.classList.add("hidden")}async handleLogin(){const e=document.getElementById("login-email").value,t=document.getElementById("login-password").value,s=document.getElementById("login-error");try{const i=await(await fetch("/api/login",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})})).json();i.success&&i.data?(this.hideModal(),this.resolveAuth({sessionId:i.data["session-id"],userId:i.data["user-id"],username:i.data.username})):s.textContent=i.error||"Login failed"}catch(n){console.error("Login error:",n),s.textContent="Connection error. Please try again."}}async handleRegister(){const e=document.getElementById("register-username").value,t=document.getElementById("register-email").value,s=document.getElementById("register-password").value,n=document.getElementById("register-error");try{const o=await(await fetch("/api/register",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,email:t,password:s})})).json();o.success?await this.loginAfterRegister(t,s):n.textContent=o.error||"Registration failed"}catch(i){console.error("Registration error:",i),n.textContent="Connection error. Please try again."}}async loginAfterRegister(e,t){this.switchTab("login"),document.getElementById("login-email").value=e,document.getElementById("login-password").value=t,await this.handleLogin()}}class m{constructor(){this.canvasManager=null,this.wsClient=null,this.authManager=null,this.sessionId=null,this.userId=null,this.username=null,this.canvasId=this.getCanvasId(),this.activeUsers=[]}getCanvasId(){let t=new URLSearchParams(window.location.search).get("canvas");if(!t){t="default-canvas";const s=new URL(window.location);s.searchParams.set("canvas",t),window.history.replaceState({},"",s)}return t}async init(){if(console.log("Initializing CollabCanvas..."),document.getElementById("canvas-id").textContent=this.canvasId,this.authManager=new E,this.sessionId=localStorage.getItem("sessionId"),this.sessionId&&(await this.validateSession()||(this.sessionId=null,localStorage.removeItem("sessionId"))),!this.sessionId){this.hideLoadingScreen();const e=await this.authManager.showModal();this.sessionId=e.sessionId,this.userId=e.userId,this.username=e.username,localStorage.setItem("sessionId",this.sessionId)}this.hideLoadingScreen(),this.initCanvas(),this.initWebSocket(),this.setupUIHandlers(),console.log("CollabCanvas initialized successfully")}hideLoadingScreen(){const e=document.getElementById("loading-screen");e&&e.classList.add("hidden")}async validateSession(){try{const e=await fetch("/api/session",{credentials:"include",headers:{Authorization:this.sessionId}});if(e.ok){const t=await e.json();if(t.success&&t.data&&t.data.valid)return this.userId=t.data["user-id"],this.username=t.data.username,console.log("Session restored:",this.username),!0}}catch(e){console.error("Session validation failed:",e)}return!1}initCanvas(){const e=document.getElementById("canvas-container"),t=new S({width:window.innerWidth,height:window.innerHeight,backgroundColor:1710618,resizeTo:window});e.appendChild(t.view),this.canvasManager=new I(t),window.getPerformanceStats=()=>this.canvasManager.getPerformanceStats(),window.getLatencyStats=()=>this.wsClient?this.wsClient.getLatencyStats():null,window.logLatencyStats=()=>{if(!this.wsClient){console.warn("WebSocket client not initialized");return}this.wsClient.logLatencyStats()},window.getLatencyStatsByType=s=>this.wsClient?this.wsClient.getLatencyStatsByType(s):null,this.canvasManager.onCursorMoved=(s,n)=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendCursorUpdate(s,n)},this.canvasManager.onObjectCreated=s=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectCreate(s)},this.canvasManager.onObjectUpdated=(s,n)=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectUpdate(s,n)},this.canvasManager.onObjectDeleted=s=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectDelete(s)},this.canvasManager.onObjectsDeleted=s=>{this.wsClient&&this.wsClient.isConnected&&this.wsClient.sendObjectsDelete(s)},this.canvasManager.onToolChange=s=>{document.getElementById("current-tool").textContent=s.charAt(0).toUpperCase()+s.slice(1)},this.canvasManager.onMouseMove=(s,n)=>{document.getElementById("mouse-position").textContent="".concat(Math.round(s),", ").concat(Math.round(n))},this.canvasManager.onZoomChange=s=>{document.getElementById("zoom-level").textContent="".concat(Math.round(s*100),"%")},this.canvasManager.onObjectCountChange=s=>{document.getElementById("object-count").textContent=s},this.canvasManager.startPeriodicCleanup(6e4),console.log("Started periodic memory cleanup (60s interval)")}initWebSocket(){const e=window.location.protocol==="https:"?"wss:":"ws:",t="".concat(e,"//").concat(window.location.host,"/ws/").concat(this.canvasId);this.wsClient=new L(t,this.sessionId,this.canvasId),this.wsClient.onAuthSuccess=s=>{console.error("=== WebSocket authenticated ==="),console.error("Auth data received:",s);const n=s["canvas-state"]||s.canvasState;console.error("canvasState exists?",!!n),console.error("canvasState type:",typeof n),console.error("canvasState length:",n?n.length:0),n?(console.error("=== CALLING loadState ==="),this.canvasManager.loadState(n),console.error("=== loadState RETURNED ===")):console.error("=== NO CANVAS STATE IN AUTH RESPONSE ===")},this.wsClient.onUserConnected=s=>{this.activeUsers.push({"user-id":s.userId||s["user-id"],username:s.username,color:s.color}),this.updatePresenceList(this.activeUsers),this.showNotification("".concat(s.username," joined"),"info")},this.wsClient.onUserDisconnected=s=>{const n=s.userId||s["user-id"];this.activeUsers=this.activeUsers.filter(i=>(i["user-id"]||i.userId)!==n),this.updatePresenceList(this.activeUsers),this.canvasManager.removeRemoteCursor(n),this.showNotification("".concat(s.username," left"),"info")},this.wsClient.onPresenceUpdate=s=>{this.activeUsers=s,this.updatePresenceList(this.activeUsers)},this.wsClient.onCursorUpdate=s=>{this.canvasManager.updateRemoteCursor(s.userId,s.username,s.x,s.y,s.color)},this.wsClient.onObjectCreated=s=>{this.canvasManager.createRemoteObject(s.object)},this.wsClient.onObjectUpdated=s=>{const n=s["object-id"]||s.objectId;this.canvasManager.updateRemoteObject(n,s.delta)},this.wsClient.onObjectDeleted=s=>{const n=s.userId||s["user-id"];this.activeUsers=this.activeUsers.filter(i=>(i["user-id"]||i.userId)!==n),this.updatePresenceList(this.activeUsers),this.canvasManager.removeRemoteCursor(n),this.showNotification("".concat(s.username," left"),"info")},this.wsClient.onObjectsDeleted=s=>{const n=s["object-ids"]||s.objectIds||[];console.log("Received bulk delete for objects:",n),n.length>0&&(n.forEach(i=>{this.canvasManager.deleteObject(i)}),console.log("Processed remote bulk deletion of ".concat(n.length," objects")))},this.wsClient.onError=s=>{console.error("WebSocket error:",s),this.showNotification("Connection error","error")},this.wsClient.onReconnecting=()=>{this.showNotification("Reconnecting...","warning")},this.wsClient.onReconnected=()=>{this.showNotification("Reconnected","success")},this.wsClient.connect()}setupUIHandlers(){document.querySelectorAll(".tool-btn").forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.tool;this.canvasManager.setTool(n),document.querySelectorAll(".tool-btn").forEach(i=>i.classList.remove("active")),s.classList.add("active")})}),document.getElementById("color-picker").addEventListener("change",s=>{this.canvasManager.setColor(s.target.value)}),document.addEventListener("keydown",s=>{if(s.target.tagName!=="INPUT")switch(s.key.toLowerCase()){case"v":this.selectTool("select");break;case"r":this.selectTool("rectangle");break;case"c":this.selectTool("circle");break;case"p":s.ctrlKey&&s.shiftKey&&(s.preventDefault(),this.runPerformanceTest());break;case"delete":case"backspace":s.target.isContentEditable||(s.preventDefault(),this.canvasManager.deleteSelected());break;case"z":(s.ctrlKey||s.metaKey)&&(s.preventDefault(),s.shiftKey?this.canvasManager.redo():this.canvasManager.undo());break}});const t=document.getElementById("logout-btn");t&&t.addEventListener("click",async()=>{await this.logout()})}selectTool(e){this.canvasManager.setTool(e),document.querySelectorAll(".tool-btn").forEach(t=>{t.dataset.tool===e?t.classList.add("active"):t.classList.remove("active")})}updatePresenceList(e=[]){const t=document.getElementById("users-container");t.innerHTML="",e.forEach(s=>{const n=document.createElement("div");n.className="user-item";const i=s.username,o=s.color;n.innerHTML='\n                <span class="user-indicator" style="background-color: '.concat(o,'"></span>\n                <span>').concat(i,"</span>\n            "),t.appendChild(n)})}showNotification(e,t="info"){console.log("[".concat(t.toUpperCase(),"] ").concat(e))}async logout(){try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.sessionId}})}catch(e){console.error("Logout error:",e)}localStorage.removeItem("sessionId"),this.canvasManager&&this.canvasManager.stopPeriodicCleanup(),this.wsClient&&this.wsClient.disconnect(),window.location.reload()}async runPerformanceTest(){console.log("Performance testing is not available in production build"),console.log("Use development build (npm run dev) for performance testing")}}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const c=new m;c.init(),window.collabCanvas=c});else{const c=new m;c.init(),window.collabCanvas=c}export{k as __vite_legacy_guard};
//# sourceMappingURL=index-CI0HO3qk.js.map
